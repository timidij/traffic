<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Light Control System</title>
    <style>
        /* =====  SAME STYLES AS FIRST FILE  ===== */
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,.3);
        }
        header h1 { font-size: 2.5rem; margin-bottom: 10px; color: #fff; }
        header p { font-size: 1.1rem; opacity: .9; }

        #main-form-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,.1);
            margin-bottom: 30px;
        }
        .individual-upload-grid {
            display: grid;
            grid-template-columns: repeat(2,1fr);
            gap: 25px;
            margin-top: 30px;
        }
        .upload-quadrant {
            border: 3px dashed #007bff;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all .3s ease;
            border-radius: 15px;
            background: #f8f9fa;
            min-height: 220px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .upload-quadrant:hover { border-color: #0056b3; background: #e3f2fd; transform: translateY(-2px); }
        .upload-quadrant.highlight { border-color: #28a745; background: #d4edda; }
        .upload-quadrant input[type="file"] { display: none; }
        .upload-quadrant h3 { margin: 0 0 15px 0; color: #007bff; font-size: 1.3rem; }
        .quadrant-image-preview {
            max-width: 90%; max-height: 150px; object-fit: contain;
            border-radius: 8px; margin-top: 15px; border: 2px solid #dee2e6; display: none;
        }
        .quadrant-image-preview:not([src=""]) { display: block; }
        .error-message-individual { color: #dc3545; font-size: .9em; margin-top: 10px; display: none; }
        #overall-error-message { color: #dc3545; margin-top: 20px; font-weight: bold; display: none; padding: 15px; background: #f8d7da; border-radius: 8px; }

        .button-container {
            display: flex; gap: 15px; justify-content: center; margin-top: 30px; flex-wrap: wrap;
        }
        .control-button {
            color: white; padding: 15px 25px; border: none; border-radius: 50px; cursor: pointer;
            font-size: 1.1em; font-weight: 600; transition: all .3s ease; min-width: 200px;
        }
        #predict-btn { background: linear-gradient(135deg,#007bff,#0056b3); }
        #predict-btn:hover:not(:disabled) { transform: translateY(-2px); }
        #predict-btn:disabled { background: #6c757d; cursor: not-allowed; }
        #stop-simulation-btn { background: linear-gradient(135deg,#dc3545,#c82333); }
        #timer-mode-btn { background: linear-gradient(135deg,#ffc107,#fd7e14); }
        .control-button:hover { transform: translateY(-2px); }

        .mode-indicator {
            text-align: center; margin: 15px 0; padding: 10px; border-radius: 8px; font-weight: 600;
        }
        .mode-smart { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .mode-timer { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }

        .results-container {
            background: white; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,.1);
            margin: 30px auto; text-align: center; display: none;
        }
        .results-container h2 { color: #0056b3; margin-bottom: 20px; }
        #overall-status-message { font-size: 1.3rem; font-weight: 600; margin-bottom: 30px; padding: 15px; border-radius: 10px; }
        .status-smart { color: #28a745; background: #d4edda; }
        .status-timer { color: #fd7e14; background: #fff3cd; }

        /* Intersection Grid & Quadrants (unchanged) */
        .intersection-grid {
            display: grid; grid-template-columns: 1fr 1.5fr 1fr; grid-template-rows: 1fr 1.5fr 1fr;
            gap: 0; background: #555; border-radius: 15px; overflow: hidden; position: relative;
            max-width: 800px; margin: 40px auto;
        }
        .intersection-grid::before {
            content: ''; grid-column: 2/3; grid-row: 2/3; background: #333; border: 2px dashed #eee;
            border-radius: 5px; margin: 5px;
        }
        .intersection-quadrant {
            background: #666; color: white; display: flex; flex-direction: column;
            align-items: center; text-align: center; padding: 10px; position: relative;
        }
        #north-approach { grid-area: 1/2/2/3; border-bottom: 2px dashed #eee; justify-content: flex-end; }
        #south-approach { grid-area: 3/2/4/3; border-top: 2px dashed #eee; justify-content: flex-start; }
        #east-approach  { grid-area: 2/3/3/4; border-left: 2px dashed #eee; flex-direction: row; justify-content: flex-start; }
        #west-approach  { grid-area: 2/1/3/2; border-right: 2px dashed #eee; flex-direction: row-reverse; justify-content: flex-end; }
        .intersection-quadrant h3 { margin: 5px 0; color: white; font-size: 1.1em; }
        .quadrant-image { max-width: 90%; max-height: 90px; object-fit: contain; border-radius: 3px; margin-top: 5px; border: 1px solid #ddd; display: none; }
        .quadrant-image:not([src=""]) { display: block; }

        /* Traffic Lights (unchanged) */
        .traffic-light {
            position: absolute; width: 25px; height: 70px; background: #222; border-radius: 8px;
            padding: 4px; display: flex; flex-direction: column; justify-content: space-around; align-items: center; z-index: 10;
        }
        .traffic-light .light { width: 20px; height: 20px; border-radius: 50%; background: #555; border: 1px solid #333; }
        .traffic-light .light.red.active   { background: #dc3545; box-shadow: 0 0 8px #dc3545; }
        .traffic-light .light.yellow.active{ background: #ffc107; box-shadow: 0 0 8px #ffc107; }
        .traffic-light .light.green.active { background: #28a745; box-shadow: 0 0 8px #28a745; }
        .traffic-light.north { top: 75%; left: 42%; transform: translateX(-50%) rotate(180deg); }
        .traffic-light.south { bottom: 75%; left: 58%; transform: translateX(-50%) rotate(0deg); }
        .traffic-light.east  { top: 42%; left: 25%; transform: translateY(-50%) rotate(90deg); }
        .traffic-light.west  { top: 58%; right: 25%; transform: translateY(-50%) rotate(-90deg); }

        /* Responsive tweaks (unchanged) */
        @media (max-width: 768px) {
            .individual-upload-grid { grid-template-columns: 1fr; }
            .upload-quadrant { min-height: 180px; padding: 20px; }
            #main-form-container { padding: 25px; }
            .intersection-grid { grid-template-columns: 1fr; grid-template-rows: repeat(4,auto); max-width: 100%; padding: 10px; }
            .intersection-grid::before { display: none; }
            .intersection-quadrant { flex-direction: column; margin-bottom: 10px; padding: 15px; border-bottom: 1px dashed #ccc; }
            #west-approach { border-bottom: none; }
            .traffic-light { position: static; transform: none; margin: 10px auto; width: 30px; height: 80px; }
            .button-container { flex-direction: column; align-items: center; }
            .control-button { width: 100%; max-width: 250px; }
        }

        /* Countdown timer style */
        #light-countdown {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.2rem;
            font-weight: bold;
            color: #007bff;
            background: rgba(255,255,255,0.85);
            border-radius: 15px;
            padding: 12px 32px;
            z-index: 100;
            pointer-events: none;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üö¶ Traffic Light Control System</h1>
            <p>Choose between AI-based or Timer-based simulation modes</p>
        </header>

        <div id="main-form-container">
            <h2 style="text-align:center;color:#0056b3;margin-bottom:20px;">Traffic Light Control Panel</h2>

            <div class="individual-upload-grid">
                <div class="upload-quadrant" id="drop-area-north">
                    <h3>üìç North Approach</h3>
                    <p>Drag & drop or click to upload</p>
                    <input type="file" id="file-input-north" accept="image/*" name="image_north">
                    <img class="quadrant-image-preview" id="preview-north" alt="North preview">
                    <div class="error-message-individual" id="error-north"></div>
                </div>

                <div class="upload-quadrant" id="drop-area-south">
                    <h3>üìç South Approach</h3>
                    <p>Drag & drop or click to upload</p>
                    <input type="file" id="file-input-south" accept="image/*" name="image_south">
                    <img class="quadrant-image-preview" id="preview-south" alt="South preview">
                    <div class="error-message-individual" id="error-south"></div>
                </div>

                <div class="upload-quadrant" id="drop-area-east">
                    <h3>üìç East Approach</h3>
                    <p>Drag & drop or click to upload</p>
                    <input type="file" id="file-input-east" accept="image/*" name="image_east">
                    <img class="quadrant-image-preview" id="preview-east" alt="East preview">
                    <div class="error-message-individual" id="error-east"></div>
                </div>

                <div class="upload-quadrant" id="drop-area-west">
                    <h3>üìç West Approach</h3>
                    <p>Drag & drop or click to upload</p>
                    <input type="file" id="file-input-west" accept="image/*" name="image_west">
                    <img class="quadrant-image-preview" id="preview-west" alt="West preview">
                    <div class="error-message-individual" id="error-west"></div>
                </div>
            </div>

            <div id="overall-error-message"></div>

            <div class="mode-indicator mode-smart" id="mode-indicator">
                üîÑ AI Mode: Upload images for smart traffic detection
            </div>

            <div class="button-container">
                <button type="button" id="predict-btn" class="control-button" disabled>üö¶ Start AI Simulation</button>
                <button type="button" id="timer-mode-btn" class="control-button">‚è∞ Start Timer Mode</button>
                <button type="button" id="stop-simulation-btn" class="control-button" style="display:none;">‚èπÔ∏è Stop Simulation</button>
            </div>
        </div>

        <!-- Results / Intersection -->
        <div class="results-container" id="results-container">
            <h2>üõ£Ô∏è Intersection Status</h2>
            <p id="overall-status-message" class="status-smart">Ready to simulate traffic flow...</p>

            <div class="intersection-grid">
                <div class="intersection-quadrant" id="north-approach">
                    <h3>North</h3>
                    <img class="quadrant-image" id="img-north" alt="North view">
                    <p>Status: <span id="status-north">Waiting...</span></p>
                    <p>Confidence: <span id="confidence-north">-</span></p>
                </div>
                <div class="traffic-light north" id="light-north">
                    <div class="light red"></div><div class="light yellow"></div><div class="light green"></div>
                </div>

                <div class="intersection-quadrant" id="west-approach">
                    <h3>West</h3>
                    <img class="quadrant-image" id="img-west" alt="West view">
                    <p>Status: <span id="status-west">Waiting...</span></p>
                    <p>Confidence: <span id="confidence-west">-</span></p>
                </div>
                <div class="traffic-light west" id="light-west">
                    <div class="light red"></div><div class="light yellow"></div><div class="light green"></div>
                </div>

                <div class="intersection-quadrant" id="east-approach">
                    <h3>East</h3>
                    <img class="quadrant-image" id="img-east" alt="East view">
                    <p>Status: <span id="status-east">Waiting...</span></p>
                    <p>Confidence: <span id="confidence-east">-</span></p>
                </div>
                <div class="traffic-light east" id="light-east">
                    <div class="light red"></div><div class="light yellow"></div><div class="light green"></div>
                </div>

                <div class="intersection-quadrant" id="south-approach">
                    <h3>South</h3>
                    <img class="quadrant-image" id="img-south" alt="South view">
                    <p>Status: <span id="status-south">Waiting...</span></p>
                    <p>Confidence: <span id="confidence-south">-</span></p>
                </div>
                <div class="traffic-light south" id="light-south">
                    <div class="light red"></div><div class="light yellow"></div><div class="light green"></div>
                </div>
<!-- Countdown timer (initially hidden) -->
<div id="light-countdown" style="
                    position: absolute;
                    top: 50%; left: 50%;
                    transform: translate(-50%, -50%);
                    font-size: 2.2rem;
                    font-weight: bold;
                    color: #007bff;
                    background: rgba(255,255,255,0.85);
                    border-radius: 15px;
                    padding: 12px 32px;
                    z-index: 100;
                    pointer-events: none;
                    display: none;
                "></div>
            </div>
        </div>
    </div>

    <script>
                    // --- CONFIG ---
        const DIRECTIONS = ['north', 'south', 'east', 'west'];
            const BATCH_INTERVAL = 10; // seconds for green/yellow cycle
            const YELLOW_INTERVAL = 2; // seconds for yellow
            const BATCH_REFRESH_INTERVAL = 30; // seconds for new random batch in AI mode

            let trafficImageData = [];
            let countdownTimer = null;
            let batchRefreshTimer = null;
            let aiModeActive = false;
            let timerModeActive = false;
            let currentPhase = 'ALL_RED';
            let phaseTimer = null;
            let phaseStartTime = 0;
            let currentTrafficDemand = { north: false, south: false, east: false, west: false };

            // DOM elements
            const predictBtn = document.getElementById('predict-btn');
            const timerModeBtn = document.getElementById('timer-mode-btn');
            const stopSimulationBtn = document.getElementById('stop-simulation-btn');
            const resultsContainer = document.getElementById('results-container');
            const overallStatusMessage = document.getElementById('overall-status-message');
            const intersectionGrid = document.querySelector('.intersection-grid');

            // --- Utility Functions ---
            function setLightColors(north, south, east, west, message) {
                DIRECTIONS.forEach(dir => {
                    const lightElement = document.getElementById(`light-${dir}`);
                    lightElement.querySelectorAll('.light').forEach(light => light.classList.remove('active'));
            });
            const lightStates = { north, south, east, west };
            for (const dir in lightStates) {
                const color = lightStates[dir];
                if (color) {
                    document.getElementById(`light-${dir}`).querySelector(`.${color}`).classList.add('active');
                }
            }
            if (message) overallStatusMessage.textContent = message;
        }

    // --- AI MODE: Fetch and display random batch ---
    async function fetchTrafficImagesJSON() {
        const resp = await fetch('/static/traffic_images_results.json');
        trafficImageData = await resp.json();
    }

                    function getRandomBatch() {
                        if (trafficImageData.length < 4) return [];
                        const shuffled = trafficImageData.slice().sort(() => Math.random() - 0.5);
                        return shuffled.slice(0, 4);
                }

                    function displayBatch(batch) {
                        DIRECTIONS.forEach((dir, i) => {
                            const info = batch[i];
                            if (!info) return;
                            document.getElementById(`img-${dir}`).src = info.image_path.replace(/\\/g, '/');
                            document.getElementById(`img-${dir}`).style.display = 'block';
                            document.getElementById(`status-${dir}`).textContent = info.status;
                            document.getElementById(`confidence-${dir}`).textContent = `${(info.confidence * 100).toFixed(2)}%`;
                        });
                        // Update currentTrafficDemand for the state machine
                        currentTrafficDemand = {};
                        DIRECTIONS.forEach((dir, i) => {
                            const status = batch[i]?.status?.toLowerCase();
                            currentTrafficDemand[dir] = (status === "traffic" || status === "vehicle");
                        });
                }

                    // --- TRAFFIC LIGHT STATE MACHINE (works for both AI and Timer mode) ---
                    function determineNextPhase() {
                        const timeElapsed = Date.now() - phaseStartTime;
                let nextPhase = currentPhase;
                    let statusMessage = "Evaluating...";

                    // Build lanesWithTraffic based on currentTrafficDemand
                    const lanesWithTraffic = [];
                    if (currentTrafficDemand.north) lanesWithTraffic.push('N_GREEN');
                    if (currentTrafficDemand.south) lanesWithTraffic.push('S_GREEN');
                    if (currentTrafficDemand.east) lanesWithTraffic.push('E_GREEN');
                    if (currentTrafficDemand.west) lanesWithTraffic.push('W_GREEN');

                    if (lanesWithTraffic.length > 0) {
                        if (currentPhase === 'ALL_RED' || timeElapsed >= BATCH_INTERVAL * 1000) {
                            // Rotate to next lane with traffic
                            const currentIndex = lanesWithTraffic.indexOf(currentPhase);
                            const nextIndex = (currentIndex + 1) % lanesWithTraffic.length;
                            nextPhase = lanesWithTraffic[nextIndex];
                            statusMessage = `${nextPhase.replace('_GREEN', ' Green')}`;
                        }
                    } else {
                    nextPhase = 'ALL_RED';
                    statusMessage = 'All Red (No traffic detected anywhere).';
                }

                    if (nextPhase !== currentPhase) {
                    currentPhase = nextPhase;
                    phaseStartTime = Date.now();
                }

                    // Set lights for the current phase
                    if (currentPhase === 'N_GREEN') {
                        setLightColors('red', 'green', 'red', 'red', 'North Green');
                    } else if (currentPhase === 'S_GREEN') {
                        setLightColors('green', 'red', 'red', 'red', 'South Green');
                    } else if (currentPhase === 'E_GREEN') {
                        setLightColors('red', 'red', 'red', 'green', 'East Green');
                    } else if (currentPhase === 'W_GREEN') {
                        setLightColors('red', 'red', 'green', 'red', 'West Green');
                    } else {
                        setLightColors('red', 'red', 'red', 'red', 'All Red');
                    }
            }

                    function startTrafficSimulation() {
                        if (phaseTimer) clearInterval(phaseTimer);
                        currentPhase = 'ALL_RED';
                        phaseStartTime = Date.now();
                        setLightColors('red', 'red', 'red', 'red', 'Starting simulation...');
            resultsContainer.style.display = 'block';
                    stopSimulationBtn.style.display = 'inline-block';
                    predictBtn.style.display = 'none';
                    phaseTimer = setInterval(determineNextPhase, 1000);
        }

                    function stopTrafficSimulation() {
                        if (phaseTimer) clearInterval(phaseTimer);
                        phaseTimer = null;
                        overallStatusMessage.textContent = 'Simulation Stopped.';
                        setLightColors('red', 'red', 'red', 'red', 'Simulation Stopped.');
                        stopSimulationBtn.style.display = 'none';
                        predictBtn.style.display = 'inline-block';
        }

                    // --- AI MODE: Batch refresh logic ---
                    function startAIBatchRefresh() {
                        let aiBatchCountdown = BATCH_REFRESH_INTERVAL;
                        clearInterval(batchRefreshTimer);
                        batchRefreshTimer = setInterval(() => {
                            aiBatchCountdown--;
                            if (aiBatchCountdown <= 0) {
                                const batch = getRandomBatch();
                                if (batch.length === 4) {
                                    displayBatch(batch);
                                    startTrafficSimulation();
                                }
                            aiBatchCountdown = BATCH_REFRESH_INTERVAL;
                        }
                    }, 1000);
        }

                    // --- BUTTONS ---
                    predictBtn.onclick = async () => {
                        aiModeActive = true;
                        timerModeActive = false;
                        predictBtn.disabled = true;
                        timerModeBtn.disabled = true;
                        stopSimulationBtn.style.display = 'inline-block';
                        resultsContainer.style.display = 'block';
                        await fetchTrafficImagesJSON();
                        const batch = getRandomBatch();
                        if (batch.length === 4) {
                            displayBatch(batch);
                            startTrafficSimulation();
                            startAIBatchRefresh();
                        }
                    };

                    timerModeBtn.onclick = () => {
                        aiModeActive = false;
                        timerModeActive = true;
                        predictBtn.disabled = true;
                        timerModeBtn.disabled = true;
                        stopSimulationBtn.style.display = 'inline-block';
                        resultsContainer.style.display = 'block';
                        // Set all roads to traffic
                        currentTrafficDemand = { north: true, south: true, east: true, west: true };
                        startTrafficSimulation();
                    };

                    stopSimulationBtn.onclick = () => {
                        stopTrafficSimulation();
                        clearInterval(batchRefreshTimer);
                        predictBtn.disabled = false;
                        timerModeBtn.disabled = false;
                    };

                    // --- INITIALIZATION ---
                    window.addEventListener('DOMContentLoaded', () => {
                        stopTrafficSimulation();
                        predictBtn.disabled = false;
                        timerModeBtn.disabled = false;
                    });
    </script>
</body>
</html>